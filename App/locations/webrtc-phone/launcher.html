<!doctype html>
<html lang="en">
<head>
    <title>example softfon page</title>
</head>
<body style="background: #adb5bd">
<div style="height: 1000px; background: #c6f5df"></div>
<div style="height: 1000px;background: #eedddd"></div>
<script type="text/javascript"  src="js/vendors/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    /* globals $ */
    $(document).ready(function() {
        let pbxHost = '172.16.156.223';
        let href = `//${pbxHost}/webrtc-phone/index.html?random=${(new Date()).getTime()}`;
        let height = $(window).height();
        if ($('iframe[src="' + href +'"').length < 1) {
          let css = 'position: fixed; z-index: 99; right: 0;bottom: 0; border: 0;';
          //  Подключаем файл style.css передавая в качестве параметра версию виджета
          $("body").prepend(`<iframe id="miko-pbx-phone" src="${href}" width="300" height="${height}" style="${css}"></iframe>`);
        }
        let resizeFunc = function (height){
            if(height === undefined){
                height = $(window).height();
            }
            $('iframe[id="miko-pbx-phone"]').attr('height', height);
        }
        $(window).resize(() => {
            resizeFunc();
            iFrame.contentWindow.postMessage({action: 'resize', height: $(window).height()}, '*');
        });

        let iFrame = document.getElementById('miko-pbx-phone');
        iFrame.onerror = function (){
            console.debug('MikoPBX', 'Error load iframe');
            $('#miko-pbx-phone').hide();
        }

        $( window ).mousemove(function( event ) {
            if( $("body").width() - event.pageX < 2){
                $('#miko-pbx-phone').show();
            }
        });

        window.addEventListener("message", function(event) {
            if(location.protocol+`//${pbxHost}` !== event.origin){
                return;
            }
            let data = JSON.parse(event.data);
            if(data.action === 'init-done'){
                resizeFunc();
                let settings = {
                    heightWindow: $(window).height(),
                    currentUser:  480711,
                    currentPhone: '201',
                    pbxHost:      '172.16.156.223',
                    users:        {
                        '203': 480711,
                        '204': 480712
                    },
                    token: 'test',
                    time_unit: 'c.'
                };
                iFrame.contentWindow.postMessage({action: 'connect', data: settings}, '*');
                return;
            }else if(data.action === 'findContact'){
                iFrame.contentWindow.postMessage({action: 'updateContact', data: {number: data.number, contact: 'МИКО ООО', id: '23233'} }, '*');
            }else if(data.action === 'openCard'){
                // Открыть карточку клиента.
            }else if(data.action === 'hide-panel'){
                $('#miko-pbx-phone').hide();
            }else if(data.action === 'resize'){
                resizeFunc(data.height);
            }
            console.debug( "received: ", event);
        });

    });
</script>


</body>
</html>